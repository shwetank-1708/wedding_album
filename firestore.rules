rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- BASIC AUTH HELPERS ---
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper to check if current user matches an ID (UID or Email)
    function isUser(id) {
      return isAuthenticated() && (
        request.auth.uid == id || 
        (request.auth.token.email != null && request.auth.token.email != "" && request.auth.token.email == id)
      );
    }

    // Safer User Profile Fetch
    function getUserData() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) 
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data 
        : null;
    }

    // Check if the current user is any type of admin
    function isAdmin() {
      let data = getUserData();
      return isAuthenticated() && data != null && data.get('role', '') == "admin";
    }

    // Check if the current user is a global Super Admin
    function isSuperAdmin() {
      let data = getUserData();
      return isAdmin() && (data.get('delegatedBy', null) == null || data.get('delegatedBy', '') == "");
    }

    // Authorizes management if user is direct owner OR authorized admin
    function isManagementAuthorized(ownerId) {
      if (!isAuthenticated()) { return false; }
      if (isUser(ownerId)) { return true; }
      
      let data = getUserData();
      if (data == null || data.get('role', '') != "admin") { return false; }
      
      // Is SuperAdmin or is delegated primary admin
      return (data.get('delegatedBy', null) == null || data.get('delegatedBy', '') == "") || 
             (data.get('delegatedBy', null) == ownerId && data.get('roleType', '') == "primary");
    }

    // Check if user is an event admin for a specific event
    function isEventAdmin(eventId) {
      let data = getUserData();
      return isAdmin() && data.get('assignedEvents', []).hasAny([eventId]);
    }

    // Helper to extract owner ID from document data
    function getDocOwnerId(data) {
      return data.get('createdBy', data.get('userId', null));
    }

    // --- COLLECTION RULES ---

    match /events/{eventId} {
      allow read: if true;
      
      allow create: if isAuthenticated() && (
        // 1. Root Event: Allow if setting self (UID or Email) as creator
        (request.resource.data.get('parentId', null) == null && isUser(request.resource.data.get('createdBy', null))) ||
        // 2. Sub Event: Authorized for the parent's creator ID
        (request.resource.data.get('parentId', null) != null && 
         exists(/databases/$(database)/documents/events/$(request.resource.data.parentId)) &&
         isManagementAuthorized(getDocOwnerId(get(/databases/$(database)/documents/events/$(request.resource.data.parentId)).data)))
      );
      
      allow update, delete: if isManagementAuthorized(getDocOwnerId(resource.data)) || isEventAdmin(eventId);
      
      match /{allSubcollections=**} {
        allow read: if true;
        allow write: if isManagementAuthorized(getDocOwnerId(get(/databases/$(database)/documents/events/$(eventId)).data));
      }
    }

    match /photos/{photoId} {
      allow read: if true;
      allow create: if isManagementAuthorized(getDocOwnerId(request.resource.data));
      allow update, delete: if isManagementAuthorized(getDocOwnerId(resource.data)) || isEventAdmin(resource.data.get('eventId', ''));
    }

    match /guests/{logId} {
      allow create: if true;
      allow read: if isAdmin();
      allow update: if isAdmin() && isManagementAuthorized(resource.data.get('parentEventOwnerId', null));
    }

    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if request.auth.uid == userId || isAdmin();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}